{{define "sidebar"}}
<div class="p-2 border-bottom">
    <a href="/{{.Silo.Slug}}/new" class="btn btn-outline-secondary btn-sm w-100 d-flex align-items-center justify-content-center">
        <i class="bi bi-plus-lg me-1"></i>
        New Page
    </a>
</div>
<div class="sidebar-tree">
    <!-- Start rendering the tree from the root pages -->
    {{range .SiloPages}}
        {{template "page-node" (dict "Node" . "Root" $)}}
    {{end}}
</div>

<!-- Delete Page Modal -->
<div class="modal fade" id="deletePageModal" tabindex="-1" aria-labelledby="deletePageModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="deletePageForm" action="" method="POST">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="deletePageModalLabel">Delete Page</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete the page "<strong id="deletePageName"></strong>"?</p>
          <p class="text-muted">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
    const deletePageModal = document.getElementById('deletePageModal');
    if (deletePageModal) {
        deletePageModal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;
            const pagePath = button.getAttribute('data-page-path');
            const pageTitle = button.getAttribute('data-page-title');
            const form = deletePageModal.querySelector('#deletePageForm');
            const pageName = deletePageModal.querySelector('#deletePageName');
            form.action = pagePath;
            pageName.textContent = pageTitle;
        });
    }
</script>
{{end}}

<!-- Recursive template for rendering a single page node in the tree -->
{{define "page-node"}}
    {{$node := .Node}}
    {{$root := .Root}}

    <div class="tree-item {{if eq $node.ID $root.Page.ID}}active{{end}}">
        <span class="tree-page-icon">
            <i class="bi bi-file-earmark-text"></i>
        </span>
        <a href="/{{$root.Silo.Slug}}/wiki/{{$node.Path}}" class="tree-item-title">
            {{$node.Title}}
        </a>
        <div class="tree-item-actions">
            <a href="/{{$root.Silo.Slug}}/new?parent={{$node.ID}}" class="action-btn" title="Add child page">
                <i class="bi bi-plus-lg"></i>
            </a>
            <a href="#" class="action-btn" data-bs-toggle="modal" data-bs-target="#deletePageModal" data-page-path="/{{$root.Silo.Slug}}/delete/{{$node.Path}}" data-page-title="{{$node.Title}}" title="Delete page">
                <i class="bi bi-trash"></i>
            </a>
        </div>
    </div>
    <!-- If the page has children, render them recursively -->
    {{if $node.Children}}
    <div class="tree-nested"> <!-- Indent child pages -->
        {{range $node.Children}}
            {{template "page-node" (dict "Node" . "Root" $root)}}
        {{end}}
    </div>
    {{end}}
{{end}}
